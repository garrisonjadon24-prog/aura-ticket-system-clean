<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner</title>
  <style>
    #cameraContainer {
      position: relative;
      width: 100%;
      height: 100%;
    }
    #autofocusStatus {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      border-radius: 5px;
      display: none;
    }
    #flashButton {
      position: absolute;
      top: 50px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Scan Ticket</h1>
  <div id="cameraContainer">
    <video id="video" autoplay playsinline></video>
    <div id="autofocusStatus">Autofocus is ON</div>
    <button id="flashButton" style="display:none;">Flash ON</button>
  </div>

  <!-- Include the html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <script>
    // Set the camera constraints and start the camera
    async function startCamera() {
      const videoElement = document.getElementById('video');
      const autofocusStatus = document.getElementById('autofocusStatus');
      const flashButton = document.getElementById('flashButton');
      let currentStream;
      let flashOn = false;
      let torchSupported = false;

      // Get the preferred camera (preferably the rear camera)
      async function getPreferredCameraConstraints() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(d => d.kind === 'videoinput');
        if (videoInputs.length === 0) return { video: true };

        const rear = videoInputs.find(d => /back|rear|environment/i.test(d.label));
        if (rear) {
          return { video: { deviceId: { exact: rear.deviceId }, facingMode: 'environment' } };
        }
        return { video: { deviceId: { exact: videoInputs[0].deviceId } } };
      }

      // Start the camera and apply settings
      try {
        const constraints = await getPreferredCameraConstraints();
        constraints.video = Object.assign(constraints.video || {}, {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: 'environment'
        });

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = currentStream;

        const track = currentStream.getVideoTracks()[0];

        // Set autofocus (only apply it once)
        const capabilities = track.getCapabilities();
        if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
          track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
          autofocusStatus.style.display = 'block';
          setTimeout(() => { autofocusStatus.style.display = 'none'; }, 3000); // Hide after 3 seconds
        }

        // Handle flash/torch functionality
        if (capabilities.torch) {
          torchSupported = true;
          flashButton.style.display = 'block';
        } else {
          flashButton.style.display = 'none';
        }

      } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Camera permission denied or no camera found.');
      }

      // Toggle flash when the button is clicked
      flashButton.addEventListener('click', () => {
        if (torchSupported) {
          flashOn = !flashOn;
          const track = currentStream.getVideoTracks()[0];
          track.applyConstraints({ advanced: [{ torch: flashOn }] });
          flashButton.textContent = flashOn ? 'Flash OFF' : 'Flash ON';
        } else {
          alert('Torch not supported on this device');
        }
      });
    }

    // Initialize QR scanner after the camera setup
    window.onload = function () {
      startCamera();

      const qrScanner = new Html5Qrcode("video");
      qrScanner.start(
        { facingMode: "environment" }, // Use rear camera
        {
          fps: 10,
          qrbox: 250,  // Increase qrbox size to capture smaller codes
          aspectRatio: 1.0,
          disableFlip: false
        },
        function (decodedText) {
          const normalizedToken = decodedText.toUpperCase().replace(/O/g, '0').replace(/I/g, '1').replace(/L/g, '1');
          alert(`Scanned: ${normalizedToken}`);
          // Add your logic here for the scan result, such as sending it to the server
        },
        function (error) {
          console.error('Scan failed:', error);
        }
      );
    };
  </script>
</body>
</html>
