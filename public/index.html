<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner</title>
  <style>
    #qr-reader {
      width: 100%;
      margin: 20px auto;
    }
    button {
      padding: 10px 15px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    #scan-result {
      font-size: 18px;
      color: green;
    }
  </style>
</head>
<body>
  <h1>Scan Ticket</h1>
  <div id="qr-reader" style="width: 300px; margin: 20px auto;"></div>
  <p id="scan-result"></p>

  <!-- Primary QR code library CDN -->
  <script id="qrLibScript" src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

  <script>
    // Fallback loader for QR code library
    function loadQrLibFallback() {
      var fallbackScript = document.createElement('script');
      fallbackScript.src = 'https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js';
      fallbackScript.onload = initQrScanner;
      fallbackScript.onerror = function() {
        document.getElementById('scan-result').innerText = 'QR Code library failed to load!';
        alert('QR Code library failed to load! Please check your internet connection or try again.');
      };
      document.body.appendChild(fallbackScript);
    }

    // Main QR scanner initialization
    function initQrScanner() {
      if (typeof Html5Qrcode === "undefined") {
        loadQrLibFallback();
        return;
      }

      function onScanSuccess(decodedText) {
        // Normalize common OCR mistakes (O -> 0, I/L -> 1)
        const normalizedToken = decodedText.toUpperCase().replace(/O/g, '0').replace(/I/g, '1').replace(/L/g, '1');
        document.getElementById('scan-result').innerText = `Scanned: ${normalizedToken}`;

        // Stop scanner to avoid duplicate reads while processing
        try {
          if (qrScanner && typeof qrScanner.stop === 'function') {
            qrScanner.stop().then(() => console.log('Scanner stopped after successful scan')).catch(() => {});
          }
        } catch (e) {
          console.warn('Error stopping scanner after success', e);
        }

        // Make an API call to verify the ticket or process the QR code
        fetch('/api/verify-ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: normalizedToken })
        })
        .then(response => response.json())
        .then(data => {
          if (data && data.ok) {
            alert(`Ticket Verified âœ…: ${data.ticketId}`);
          } else {
            alert('Invalid Ticket âŒ');
          }
        })
        .catch(err => {
          console.error('Ticket verification error:', err);
          alert('Ticket verification failed. See console for details.');
        });
      }

      function onScanFailure(error) {
        console.error('Scan failed:', error);
      }

      // Initialize the QR scanner
      const qrScanner = new Html5Qrcode("qr-reader");

      // Dynamically choose qrbox size based on viewport to help with small QR codes
      function calculateQrBox() {
        const smaller = Math.min(window.innerWidth, window.innerHeight);
        // Use up to 70% of the smaller dimension but clamp between 240 and 420
        return Math.max(240, Math.min(420, Math.floor(smaller * 0.7)));
      }

      const startConfig = {
        fps: 10,
        qrbox: calculateQrBox(),
        aspectRatio: 1.0,
        disableFlip: false
      };

      // Recalculate qrbox on resize for responsive behavior
      window.addEventListener('resize', () => {
        try {
          const newBox = calculateQrBox();
          // Html5Qrcode doesn't currently expose a simple setter for qrbox while running.
          // Best approach is to stop and restart if size changes significantly.
          // For simplicity, only act when there's a large change.
          if (Math.abs(startConfig.qrbox - newBox) > 60) {
            startConfig.qrbox = newBox;
            if (qrScanner && typeof qrScanner.stop === 'function') {
              qrScanner.stop().then(() => {
                qrScanner.start({ facingMode: 'environment' }, startConfig, onScanSuccess, onScanFailure).catch(console.error);
              }).catch(console.error);
            }
          }
        } catch (e) { console.warn('Resize handling error', e); }
      });

      qrScanner.start(
        { facingMode: "environment" },
        startConfig,
        onScanSuccess,
        onScanFailure
      ).then((stream) => {
        let currentStream = stream;
        const track = currentStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities ? track.getCapabilities() : {};
        const settings = track.getSettings ? track.getSettings() : {};

        // Torch (flashlight) toggle, only if supported
        const controls = document.createElement('div');
        controls.style.textAlign = 'center';
        controls.style.marginTop = '8px';
        document.getElementById('qr-reader').after(controls);

        if (capabilities.torch) {
          const torchButton = document.createElement('button');
          torchButton.id = 'torch-toggle';
          torchButton.textContent = 'ðŸ’¡ Flash ON';
          torchButton.style.marginRight = '8px';
          controls.appendChild(torchButton);
          torchButton.onclick = () => {
            const flashOn = !torchButton.classList.contains('active');
            track.applyConstraints({ advanced: [{ torch: flashOn }] })
              .then(() => {
                torchButton.classList.toggle('active', flashOn);
                torchButton.textContent = flashOn ? 'ðŸ’¡ Flash OFF' : 'ðŸ’¡ Flash ON';
              }).catch(err => {
                console.error('Torch toggle failed:', err);
                alert('Failed to toggle torch. See console for details.');
              });
          };
        } else {
          const info = document.createElement('span');
          info.style.fontSize = '14px';
          info.style.color = '#666';
          info.textContent = 'Torch not supported on this device.';
          controls.appendChild(info);
        }

        // Autofocus handling: attempt via track if supported, otherwise via video element
        (async function tryApplyAutofocus() {
          try {
            const hasFocusMode = capabilities.focusMode && capabilities.focusMode.length;
            const currentFocus = settings.focusMode;

            if (hasFocusMode && currentFocus !== 'continuous' && capabilities.focusMode.includes('continuous')) {
              await track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
              console.log('Autofocus (continuous) applied via track constraints');
            } else if (currentFocus === 'continuous') {
              console.log('Autofocus already enabled by device');
            } else {
              // Try applying to video element as a fallback
              const videoEl = document.querySelector('#qr-reader video');
              if (videoEl && videoEl.srcObject) {
                const vtracks = videoEl.srcObject.getVideoTracks();
                if (vtracks && vtracks.length > 0) {
                  try {
                    await vtracks[0].applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                    console.log('Autofocus applied via video track constraints');
                    return;
                  } catch (e) {
                    console.warn('Could not apply autofocus via video track:', e);
                  }
                }
              }
              console.warn('Autofocus not supported on this device. Small QR codes may be harder to scan.');
              const msg = document.createElement('div');
              msg.style.color = '#b55';
              msg.style.fontSize = '14px';
              msg.style.marginTop = '6px';
              msg.textContent = 'Autofocus not supported â€” try moving the camera closer/farther or tapping to focus.';
              controls.appendChild(msg);
            }
          } catch (e) {
            console.warn('Autofocus attempt failed:', e);
          }
        })();
      }).catch(err => {
        if (err && err.name === 'NotAllowedError') {
          document.getElementById('scan-result').innerText = 'Camera access denied. Please allow camera permissions.';
          alert('Camera access denied. Please allow camera permissions.');
        } else {
          document.getElementById('scan-result').innerText = 'Camera error: ' + (err && err.message ? err.message : err);
          console.error('Camera start error:', err);
          alert('Camera error: ' + (err && err.message ? err.message : err));
        }
      });
    }

    // Wait for QR library to load, then initialize
    document.getElementById('qrLibScript').onload = initQrScanner;
    document.getElementById('qrLibScript').onerror = function() {
      // Try fallback CDN
      loadQrLibFallback();
    };
    
    // If document is already loaded, but script is cached, try to initialize
    if (typeof Html5Qrcode !== "undefined") {
      initQrScanner();
    }
  </script>
</body>
</html>